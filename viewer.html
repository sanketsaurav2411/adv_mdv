<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Markdown Viewer — Web (debug)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Keep original CSS but protect viewer visuals with explicit styles below -->
  <link rel="stylesheet" href="content/index.css" />
  <link rel="stylesheet" href="content/themes.css" />

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism.css" />

  <style>
    :root{--bg:#0b1220;--panel:#071028;--text:#dbeafe}
    html,body{height:100%;margin:0;font-family:system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial;background:var(--bg); color:var(--text);}
    header{background:#0f1724;padding:10px 14px;font-weight:600}
    .wrap{display:flex;flex:1;gap:12px;padding:12px;box-sizing:border-box;height:calc(100vh - 52px)}
    .left{width:420px;min-width:260px;background:var(--panel);padding:12px;border-radius:8px;box-shadow:0 6px 18px rgba(2,6,23,.6);overflow:auto}
    .right{flex:1;background:#fff;border-radius:8px;padding:16px;overflow:auto;color:#111;position:relative}
    #render{max-width:900px;margin:0 auto; color:initial !important; background:transparent !important}
    /* Protect render area from being hidden by other CSS */
    #render, #render * { visibility: visible !important; display: block !important; opacity: 1 !important; color: inherit !important; }
    /* Ensure body-level CSS from content/* can't hide right panel */
    .right { min-height: 100px; }
    .controls .btn{cursor:pointer}
    .errorBox{position:fixed;right:12px;bottom:12px;left:12px;max-height:35vh;overflow:auto;background:#1f2937;color:#ffe4e6;padding:10px;border-radius:8px;border:2px solid #991b1b;z-index:99999;font-family:monospace;font-size:12px}
    .muted{color:#9fb6d9;font-size:13px}
    pre code{white-space:pre;display:block;padding:8px;border-radius:6px;background:#f5f5f5;overflow:auto}
    .dropzone{border:2px dashed rgba(255,255,255,0.06);padding:14px;border-radius:6px;margin-top:8px;text-align:center;color:#9fb6d9}
    #debugLog{font-family:monospace;font-size:12px;color:#9fb6d9;white-space:pre-wrap;max-height:18vh;overflow:auto;background:rgba(0,0,0,0.08);padding:8px;border-radius:6px;margin-top:10px}
  </style>
</head>
<body>
  <header>Markdown Viewer — Web (debug)</header>

  <div class="wrap">
    <div class="left">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div>
          <div style="font-weight:700">Open / Upload</div>
          <div class="muted">Choose a .md file or paste markdown below</div>
        </div>
        <div style="text-align:right">
          <button id="openFile" class="btn">Choose file</button>
        </div>
      </div>

      <input id="fileInput" type="file" accept=".md,.markdown,.txt" style="display:none" />

      <div class="dropzone" id="dropzone">Drag & drop a .md file here</div>

      <div style="margin-top:10px">
        <label class="muted">Or paste markdown (live preview)</label>
        <textarea id="mdinput" placeholder="# Paste markdown here" style="width:100%;height:220px;resize:vertical;padding:8px;font-family:monospace"></textarea>
      </div>

      <div style="margin-top:10px" class="controls">
        <button id="clearBtn" class="btn">Clear</button>
        <button id="downloadHtml" class="btn">Download HTML</button>
        <button id="openUrlBtn" class="btn">Open from URL</button>
        <input id="urlInput" type="text" placeholder="https://raw.githubusercontent.com/..." style="flex:1;padding:6px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--text)" />
      </div>

      <div id="debugLog" aria-hidden="false">debug log:\n</div>
    </div>

    <div class="right">
      <div id="render" role="main" aria-live="polite">
        <!-- rendered markdown goes here -->
      </div>
    </div>
  </div>

  <!-- Markdown-it + plugins + Prism -->
  <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/markdown-it-footnote@3.0.3/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/markdown-it-deflist@2.0.3/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-python.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-javascript.min.js"></script>

<script>
/* ------------------------------
   Debug helpers & runtime guard
   ------------------------------ */
(function(){
  const debugLog = document.getElementById('debugLog');
  function dbg(...args){
    const line = args.map(a => (typeof a === 'string' ? a : JSON.stringify(a))).join(' ');
    console.log('[viewer-debug]', ...args);
    debugLog.textContent += '\\n' + line;
    debugLog.scrollTop = debugLog.scrollHeight;
  }

  // Capture runtime errors & unhandled rejections and show on-screen
  window.addEventListener('error', function(ev){
    const msg = ev && ev.error ? (ev.error.stack || ev.error.message || ev.error) : (ev && ev.message) || String(ev);
    showError('Uncaught error: ' + msg);
    dbg('error', msg);
  });
  window.addEventListener('unhandledrejection', function(ev){
    const msg = ev && ev.reason ? (ev.reason.stack || ev.reason.message || ev.reason) : String(ev);
    showError('Unhandled rejection: ' + msg);
    dbg('unhandledrejection', msg);
  });

  // Small visible error display
  function showError(text){
    dbg('showError:', text);
    let box = document.getElementById('errorBox');
    if (!box){
      box = document.createElement('div');
      box.id = 'errorBox';
      box.className = 'errorBox';
      document.body.appendChild(box);
    }
    const time = new Date().toLocaleTimeString();
    box.innerHTML = '<strong>Runtime error ('+time+')</strong><pre style="white-space:pre-wrap;margin-top:8px;">' + escapeHtml(text) + '</pre>';
  }
  function escapeHtml(s){ return String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

  // Monitor network failures for resources (best-effort)
  const origFetch = window.fetch;
  window.fetch = function(...args){
    return origFetch.apply(this,args).then(r=>{
      if (!r.ok) dbg('fetch', args[0], 'status', r.status);
      return r;
    }).catch(e=>{
      dbg('fetch-error', args[0], String(e));
      throw e;
    });
  };

  // Protect #render even if later scripts try to remove it
  const render = document.getElementById('render');
  const observer = new MutationObserver(muts=>{
    for (const m of muts){
      // If someone removed render or set display:none, restore it
      if (!document.body.contains(render)){
        dbg('render removed — restoring');
        document.body.querySelector('.right').appendChild(render);
      }
      const s = getComputedStyle(render);
      if (s && (s.display === 'none' || s.visibility === 'hidden' || s.opacity === '0')){
        dbg('render hidden by CSS — forcing visible');
        render.style.display = 'block';
        render.style.visibility = 'visible';
        render.style.opacity = 1;
      }
    }
  });
  observer.observe(document.documentElement, {childList:true, subtree:true, attributes:true, attributeFilter:['style','class']});

  dbg('debug helpers installed');
})();

/* ------------------------------
   Viewer app (safe execution)
   ------------------------------ */
(function(){
  // ensure errors inside our code get reported
  try{
    const md = window.markdownit({ html: true, linkify: true, typographer: true })
      .use(window.markdownitFootnote || function() {})
      .use(window.markdownitDeflist || function() {});

    const input = document.getElementById('mdinput');
    const renderEl = document.getElementById('render');
    const fileInput = document.getElementById('fileInput');
    const openFile = document.getElementById('openFile');
    const dropzone = document.getElementById('dropzone');
    const clearBtn = document.getElementById('clearBtn');
    const downloadHtml = document.getElementById('downloadHtml');
    const openUrlBtn = document.getElementById('openUrlBtn');
    const urlInput = document.getElementById('urlInput');

    function renderMarkdown(text){
      try{
        renderEl.innerHTML = md.render(text || '');
        Prism.highlightAllUnder(renderEl);
        const imgs = renderEl.querySelectorAll('img');
        imgs.forEach(i => { i.style.maxWidth = '100%'; });
      }catch(e){
        // show error but keep page
        window.dispatchEvent(new ErrorEvent('error', { error: e, message: e && e.message }));
      }
    }

    // Live preview
    input.addEventListener('input', ()=> renderMarkdown(input.value));
    input.value = '# Welcome to Markdown Viewer\\n\\nDrop a .md file or paste markdown here.';
    renderMarkdown(input.value);

    // File open
    openFile.addEventListener('click', ()=> fileInput.click());
    fileInput.addEventListener('change', (e) => {
      const f = e.target.files[0];
      if (!f) return;
      const reader = new FileReader();
      reader.onload = () => { input.value = reader.result; renderMarkdown(reader.result); };
      reader.readAsText(f);
    });

    // Drag & drop
    dropzone.addEventListener('dragover', e => { e.preventDefault(); dropzone.style.borderColor = '#0ea5e9'; });
    dropzone.addEventListener('dragleave', e => { dropzone.style.borderColor = ''; });
    dropzone.addEventListener('drop', e => {
      e.preventDefault(); dropzone.style.borderColor = '';
      const f = e.dataTransfer.files[0];
      if (!f) return;
      const reader = new FileReader();
      reader.onload = () => { input.value = reader.result; renderMarkdown(reader.result); };
      reader.readAsText(f);
    });

    // Clear
    clearBtn.addEventListener('click', ()=> { input.value=''; renderMarkdown(''); });

    // Download rendered HTML
    downloadHtml.addEventListener('click', ()=>{
      try{
        const html = `<!doctype html><html><head><meta charset="utf-8"><title>Export</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism.css"></head>
<body>${renderEl.innerHTML}</body></html>`;
        const blob = new Blob([html], {type:'text/html'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'rendered.html'; a.click();
        URL.revokeObjectURL(url);
      }catch(e){ window.dispatchEvent(new ErrorEvent('error', { error: e, message: e && e.message })); }
    });

    // Open raw URL
    openUrlBtn.addEventListener('click', async ()=>{
      const u = urlInput.value.trim();
      if (!u) return alert('Enter a raw URL (raw.githubusercontent.com...)');
      try {
        const res = await fetch(u);
        if (!res.ok) throw new Error('status ' + res.status);
        const txt = await res.text();
        input.value = txt;
        renderMarkdown(txt);
      } catch (err) {
        alert('Failed to fetch: ' + err.message);
      }
    });

    // accept ?url=...
    const params = new URLSearchParams(location.search);
    if (params.get('url')) {
      urlInput.value = params.get('url');
      openUrlBtn.click();
    }
  } catch (err){
    window.dispatchEvent(new ErrorEvent('error', { error: err, message: err && err.message }));
  }
})();
</script>
</body>
</html>
