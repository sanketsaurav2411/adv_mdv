<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
<meta http-equiv="refresh" content="0;url=viewer.html">

  <title>Markdown Viewer (Web Version) — injected popup</title>
    <meta http-equiv="refresh" content="0;url=popup_web.html">

  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { margin:0; font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial; background:#0f172a; color:#e6eef8; }
    header { background:#1e293b; padding:10px 16px; font-size:16px; font-weight:600; color:#fff; }
    .cols { display:flex; height:calc(100vh - 48px); gap:12px; padding:12px; box-sizing:border-box; }
    .left { width:320px; max-width:35%; background:#071028; border-radius:8px; padding:12px; box-sizing:border-box; }
    .right { flex:1; background:#071022; border-radius:8px; padding:8px; box-sizing:border-box; display:flex; flex-direction:column; }
    iframe { border: none; width:100%; height:100%; border-radius:6px; background:#fff; }
    .log { font-family:monospace; font-size:13px; color:#9fb6d9; white-space:pre-wrap; margin-top:8px; }
    .btn { display:inline-block; margin-top:8px; background:#0ea5e9; color:#02243a; padding:6px 10px; border-radius:6px; text-decoration:none; font-weight:600; }
    .error { color:#ff9b9b; }
    .success { color:#b9f6c6; }
  </style>
</head>
<body>
  <header>Markdown Viewer (Web Version) — loading extension popup</header>

  <div class="cols">
    <div class="left">
      <div><strong>Status</strong></div>
      <div id="status" class="log">starting…</div>

      <div style="margin-top:10px;">
        <div><strong>Quick links</strong></div>
        <a id="openPopupDirect" class="btn" target="_blank" rel="noopener">Open popup/index.html directly</a>
      </div>

      <div style="margin-top:12px;">
        <div><strong>Debug console</strong></div>
        <div id="debug" class="log"></div>
      </div>
    </div>

    <div class="right">
      <iframe id="popupFrame" title="popup preview"></iframe>
    </div>
  </div>

<script>
(async function(){
  const status = document.getElementById('status');
  const debug = document.getElementById('debug');
  const iframe = document.getElementById('popupFrame');
  const openDirect = document.getElementById('openPopupDirect');

  function log(msg, cls) {
    console.log(msg);
    debug.textContent += msg + "\n";
    status.textContent = msg;
    if (cls === 'error') status.className = 'error';
    if (cls === 'success') status.className = 'success';
  }

  // Compute base URL for popup folder (works whether served at /adv_mdv/ or root)
  // location.pathname might be '/adv_mdv/' or '/adv_mdv' so normalize
  const basePath = (function(){
    const p = location.pathname.replace(/\/$/, ''); // '/adv_mdv' or ''
    const repoBase = p === '' ? '' : p; 
    // popup folder relative to repo root
    return location.origin + repoBase + '/popup/';
  })();

  // Set direct link to open popup file directly (handy)
  openDirect.href = basePath + 'index.html';

  // Try fetching popup/index.html
  const popupPath = 'popup/index.html'; // relative fetch
  log('Fetching ' + popupPath + ' ...');

  try {
    const res = await fetch(popupPath);
    if (!res.ok) {
      log('Failed to fetch popup/index.html — status ' + res.status, 'error');
      // show direct link so user can inspect
      iframe.src = popupPath;
      return;
    }
    let html = await res.text();
    log('popup/index.html fetched (size: ' + html.length + ' bytes)', 'success');

    // Inject shim script at top so popup scripts see chrome.* etc.
    const shim = `
        <script>
        // lightweight chrome/browser shims (injected inside popup)
        window.chrome = window.chrome || {};
        window.browser = window.browser || {};
        chrome.runtime = chrome.runtime || {};
        chrome.runtime.getURL = chrome.runtime.getURL || function(p){ return p; };
        chrome.runtime.sendMessage = chrome.runtime.sendMessage || function(){};
        chrome.runtime.connect = chrome.runtime.connect || function(){ return { onMessage:{ addListener: ()=>{} }, postMessage: ()=>{} }; };
        chrome.storage = chrome.storage || { local:{ get: (k,cb)=>{ cb && cb({}); }, set:(o,cb)=>{ cb && cb(); } } };
        </script>
        `;

    // Add <base> tag so relative links inside popup resolve to the popup folder on GitHub Pages.
    // Use full absolute base (origin + path) to be safe.
    const baseTag = `<base href="${basePath}">`;

    // Place base tag after <head> or create a head if missing.
    if (/<head[^>]*>/i.test(html)) {
      html = html.replace(/<head([^>]*)>/i, `<head$1>\n${baseTag}\n${shim}`);
    } else if (/<html[^>]*>/i.test(html)) {
      // create head
      html = html.replace(/<html([^>]*)>/i, `<html$1>\n<head>\n${baseTag}\n${shim}\n</head>`);
    } else {
      // prepend head
      html = `<!doctype html>\n<html>\n<head>\n${baseTag}\n${shim}\n</head>\n<body>\n` + html + '\n</body>\n</html>';
    }

    // Optionally we can add a CSP meta if needed, but avoid interfering.

    // Now load HTML into iframe using srcdoc
    iframe.srcdoc = html;
    log('Injected popup into iframe via srcdoc. If UI appears blank, open console to see errors.', 'success');

    // Listen for iframe load & runtime errors (we cannot catch inside iframe easily due to isolation)
    iframe.addEventListener('load', () => {
      log('iframe load event fired. iframe document may be interactive now.');
    });

    // If popup still blank, offer to open direct path (we already set the link).
  } catch (err) {
    log('Exception while fetching/injecting popup: ' + err, 'error');
    // fallback: open direct
    iframe.src = popupPath;
  }

})();
</script>
</body>
</html>